{% extends "base.html" %}

{% block title %}مقارنة المنتجات{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-columns text-blue-500"></i>
                مقارنة المنتجات - جميع التطبيقات
            </h1>
            <p class="text-sm text-gray-500 mt-1" id="stats-text">جاري التحميل...</p>
        </div>
        <button onclick="loadMatrix()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
            <i class="fas fa-sync-alt"></i> تحديث
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex flex-wrap gap-4 items-center">
            <select id="filter-app" class="border rounded-lg px-3 py-2" onchange="loadMatrix()">
                <option value="">جميع التطبيقات</option>
                <option value="ben_soliman">بن سليمان</option>
                <option value="tager_elsaada">تاجر السعادة</option>
                <option value="el_rabie">الربيع</option>
                <option value="gomla_shoaib">جملة شعيب</option>
            </select>
            <input type="text" id="filter-search" class="border rounded-lg px-3 py-2 flex-1 min-w-[200px]"
                   placeholder="بحث بالاسم أو الباركود..." onkeyup="debounceSearch()">
            <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" id="filter-unlinked" onchange="loadMatrix()">
                <span>المنتجات غير المربوطة فقط</span>
            </label>
        </div>
    </div>

    <!-- Comparison Matrix Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full" id="matrix-table">
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th class="px-3 py-3 text-right text-xs font-semibold text-gray-600 w-24">الباركود</th>
                        <th class="px-3 py-3 text-center text-xs font-semibold text-white bg-blue-500 w-1/4">
                            <i class="fas fa-store"></i> بن سليمان
                        </th>
                        <th class="px-3 py-3 text-center text-xs font-semibold text-white bg-green-500 w-1/4">
                            <i class="fas fa-store"></i> تاجر السعادة
                        </th>
                        <th class="px-3 py-3 text-center text-xs font-semibold text-white bg-orange-500 w-1/4">
                            <i class="fas fa-store"></i> الربيع
                        </th>
                        <th class="px-3 py-3 text-center text-xs font-semibold text-white bg-red-500 w-1/4">
                            <i class="fas fa-store"></i> جملة شعيب
                        </th>
                    </tr>
                </thead>
                <tbody id="matrix-body" class="divide-y divide-gray-200">
                    <tr><td colspan="5" class="text-center py-8 text-gray-500">جاري التحميل...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div id="matrix-pagination" class="flex justify-center gap-2"></div>
</div>

<!-- Link Modal -->
<div id="link-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-hidden">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold" id="modal-title">ربط المنتج</h3>
            <button onclick="closeLinkModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-4 overflow-y-auto max-h-[70vh]">
            <!-- Source Product Info -->
            <div class="bg-gray-50 rounded-lg p-3 mb-4">
                <p class="text-sm text-gray-500">المنتج المصدر:</p>
                <p class="font-semibold" id="source-product-name"></p>
                <p class="text-xs text-gray-500" id="source-product-barcode"></p>
            </div>

            <!-- Tabs -->
            <div class="flex border-b mb-4">
                <button onclick="switchModalTab('smart')" id="modal-tab-smart"
                        class="px-4 py-2 border-b-2 border-blue-500 text-blue-600 font-medium">
                    <i class="fas fa-magic"></i> اقتراحات ذكية
                </button>
                <button onclick="switchModalTab('search')" id="modal-tab-search"
                        class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium">
                    <i class="fas fa-search"></i> بحث يدوي
                </button>
            </div>

            <!-- Smart Suggestions -->
            <div id="modal-content-smart">
                <div id="smart-suggestions" class="space-y-2">
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-spinner fa-spin"></i> جاري البحث عن اقتراحات...
                    </div>
                </div>
            </div>

            <!-- Manual Search -->
            <div id="modal-content-search" class="hidden">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="manual-search-input" class="border rounded-lg px-3 py-2 flex-1"
                           placeholder="ابحث عن المنتج..." onkeyup="debounceManualSearch()">
                    <button onclick="doManualSearch()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="search-results" class="space-y-2">
                    <p class="text-center text-gray-500 text-sm">أدخل كلمة للبحث</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const appColors = {
        'ben_soliman': { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', name: 'بن سليمان' },
        'tager_elsaada': { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-700', name: 'تاجر السعادة' },
        'el_rabie': { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700', name: 'الربيع' },
        'gomla_shoaib': { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-700', name: 'جملة شعيب' }
    };

    const appKeys = ['ben_soliman', 'tager_elsaada', 'el_rabie', 'gomla_shoaib'];

    let currentPage = 1;
    let searchTimeout = null;
    let manualSearchTimeout = null;
    let currentSourceProduct = null;
    let currentTargetApp = null;

    async function loadMatrix(page = 1) {
        currentPage = page;
        const sourceApp = document.getElementById('filter-app').value;
        const search = document.getElementById('filter-search').value;
        const unlinkedOnly = document.getElementById('filter-unlinked').checked;

        const tbody = document.getElementById('matrix-body');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</td></tr>';

        try {
            let url = `/comparison/matrix?page=${page}&per_page=30`;
            if (sourceApp) url += `&source_app=${sourceApp}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (unlinkedOnly) url += `&show_unlinked_only=true`;

            const data = await fetchAPI(url);

            // Update stats
            document.getElementById('stats-text').textContent =
                `${data.meta.total} منتج - صفحة ${data.meta.page} من ${data.meta.total_pages}`;

            if (data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">لا توجد منتجات</td></tr>';
                document.getElementById('matrix-pagination').innerHTML = '';
                return;
            }

            tbody.innerHTML = data.data.map(row => {
                const cells = appKeys.map(app => {
                    const item = row[app];
                    const colors = appColors[app];

                    if (item && item.product_id) {
                        // Product exists
                        const priceClass = item.is_available ? 'text-green-600' : 'text-gray-400 line-through';
                        return `
                            <td class="px-2 py-2 ${colors.bg} border-l ${colors.border}">
                                <div class="text-xs">
                                    <a href="/products/${item.product_id}" class="font-medium hover:underline ${colors.text}" title="${item.name}">
                                        ${item.name?.substring(0, 25) || '-'}${item.name?.length > 25 ? '...' : ''}
                                    </a>
                                    <div class="${priceClass} font-bold mt-1">
                                        ${item.price ? item.price.toFixed(2) + ' ج.م' : '-'}
                                    </div>
                                    ${item.is_linked && item.link_id ? '<span class="text-xs text-blue-500"><i class="fas fa-link"></i></span>' : ''}
                                </div>
                            </td>
                        `;
                    } else {
                        // Product doesn't exist - show link button
                        return `
                            <td class="px-2 py-2 bg-gray-50 border-l border-gray-200 text-center">
                                <button onclick="openLinkModal(${row.primary_product_id}, '${row.primary_name.replace(/'/g, "\\'")}', '${row.barcode || ''}', '${app}')"
                                        class="text-xs text-gray-400 hover:text-blue-500 hover:bg-blue-50 px-2 py-1 rounded transition-all"
                                        title="ربط مع ${colors.name}">
                                    <i class="fas fa-plus-circle"></i>
                                    <span class="hidden sm:inline">ربط</span>
                                </button>
                            </td>
                        `;
                    }
                }).join('');

                // Calculate price difference
                const prices = appKeys.map(app => row[app]?.price).filter(p => p);
                const priceDiff = prices.length > 1 ? Math.max(...prices) - Math.min(...prices) : null;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-2 py-2 text-xs">
                            <div class="font-mono text-gray-600">${row.barcode || '-'}</div>
                            ${priceDiff ? `<div class="text-orange-500 text-xs mt-1">فرق: ${priceDiff.toFixed(2)}</div>` : ''}
                        </td>
                        ${cells}
                    </tr>
                `;
            }).join('');

            // Pagination
            renderPagination(data.meta);
        } catch (err) {
            console.error('Error loading matrix:', err);
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">حدث خطأ في التحميل</td></tr>';
        }
    }

    function renderPagination(meta) {
        const container = document.getElementById('matrix-pagination');
        if (meta.total_pages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';
        const maxButtons = 7;
        let start = Math.max(1, meta.page - 3);
        let end = Math.min(meta.total_pages, start + maxButtons - 1);

        if (meta.page > 1) {
            html += `<button onclick="loadMatrix(${meta.page - 1})" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300"><i class="fas fa-chevron-right"></i></button>`;
        }

        for (let i = start; i <= end; i++) {
            html += `<button onclick="loadMatrix(${i})" class="px-3 py-1 rounded ${i === meta.page ? 'bg-blue-500 text-white' : 'bg-gray-200 hover:bg-gray-300'}">${i}</button>`;
        }

        if (meta.page < meta.total_pages) {
            html += `<button onclick="loadMatrix(${meta.page + 1})" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300"><i class="fas fa-chevron-left"></i></button>`;
        }

        container.innerHTML = html;
    }

    function openLinkModal(productId, productName, barcode, targetApp) {
        currentSourceProduct = { id: productId, name: productName, barcode: barcode };
        currentTargetApp = targetApp;

        document.getElementById('modal-title').textContent = `ربط المنتج مع ${appColors[targetApp].name}`;
        document.getElementById('source-product-name').textContent = productName;
        document.getElementById('source-product-barcode').textContent = barcode ? `باركود: ${barcode}` : 'بدون باركود';

        // Reset tabs
        switchModalTab('smart');

        // Show modal
        document.getElementById('link-modal').classList.remove('hidden');

        // Load smart suggestions
        loadSmartSuggestions(productId, targetApp);
    }

    function closeLinkModal() {
        document.getElementById('link-modal').classList.add('hidden');
        currentSourceProduct = null;
        currentTargetApp = null;
    }

    function switchModalTab(tab) {
        ['smart', 'search'].forEach(t => {
            document.getElementById(`modal-tab-${t}`).classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById(`modal-tab-${t}`).classList.add('border-transparent', 'text-gray-500');
            document.getElementById(`modal-content-${t}`).classList.add('hidden');
        });

        document.getElementById(`modal-tab-${tab}`).classList.remove('border-transparent', 'text-gray-500');
        document.getElementById(`modal-tab-${tab}`).classList.add('border-blue-500', 'text-blue-600');
        document.getElementById(`modal-content-${tab}`).classList.remove('hidden');
    }

    async function loadSmartSuggestions(productId, targetApp) {
        const container = document.getElementById('smart-suggestions');
        container.innerHTML = '<div class="text-center py-4 text-gray-500"><i class="fas fa-spinner fa-spin"></i> جاري البحث عن اقتراحات...</div>';

        try {
            const data = await fetchAPI(`/product-links/smart-match/${productId}?target_app=${targetApp}&limit=5`);

            if (data.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500"><i class="fas fa-exclamation-circle"></i> لا توجد اقتراحات</div>';
                return;
            }

            container.innerHTML = data.map((match, idx) => {
                const scorePercent = (match.score * 100).toFixed(0);
                const scoreColor = match.score > 0.8 ? 'text-green-600' : match.score > 0.6 ? 'text-yellow-600' : 'text-orange-600';
                const matchTypeIcon = {
                    'barcode': 'fa-barcode',
                    'sku': 'fa-tag',
                    'brand': 'fa-trademark',
                    'name': 'fa-font',
                    'similarity': 'fa-equals'
                }[match.match_type] || 'fa-link';

                return `
                    <div class="border rounded-lg p-3 hover:bg-gray-50 ${idx === 0 ? 'border-green-300 bg-green-50' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-sm">${match.name}</div>
                                <div class="text-xs text-gray-500 mt-1">
                                    ${match.barcode ? `<span class="mr-2"><i class="fas fa-barcode"></i> ${match.barcode}</span>` : ''}
                                    ${match.price ? `<span class="text-green-600 font-bold">${match.price.toFixed(2)} ج.م</span>` : ''}
                                </div>
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${match.match_reasons.map(r => `<span class="text-xs bg-gray-200 px-2 py-0.5 rounded">${r}</span>`).join('')}
                                </div>
                            </div>
                            <div class="text-left mr-3">
                                <div class="flex items-center gap-1 ${scoreColor}">
                                    <i class="fas ${matchTypeIcon}"></i>
                                    <span class="font-bold">${scorePercent}%</span>
                                </div>
                                <button onclick="createLink(${currentSourceProduct.id}, ${match.product_id})"
                                        class="mt-2 bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600">
                                    <i class="fas fa-link"></i> ربط
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (err) {
            console.error('Error loading suggestions:', err);
            container.innerHTML = '<div class="text-center py-4 text-red-500">حدث خطأ في تحميل الاقتراحات</div>';
        }
    }

    function debounceManualSearch() {
        clearTimeout(manualSearchTimeout);
        manualSearchTimeout = setTimeout(doManualSearch, 300);
    }

    async function doManualSearch() {
        const query = document.getElementById('manual-search-input').value.trim();
        const container = document.getElementById('search-results');

        if (query.length < 2) {
            container.innerHTML = '<p class="text-center text-gray-500 text-sm">أدخل كلمة للبحث (حرفين على الأقل)</p>';
            return;
        }

        container.innerHTML = '<div class="text-center py-4 text-gray-500"><i class="fas fa-spinner fa-spin"></i> جاري البحث...</div>';

        try {
            const data = await fetchAPI(`/product-links/search-in-app?query=${encodeURIComponent(query)}&source_app=${currentTargetApp}&limit=10`);

            if (data.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500">لا توجد نتائج</div>';
                return;
            }

            container.innerHTML = data.map(product => `
                <div class="border rounded-lg p-3 hover:bg-gray-50 flex justify-between items-center">
                    <div>
                        <div class="font-medium text-sm">${product.name}</div>
                        <div class="text-xs text-gray-500">
                            ${product.barcode ? `<i class="fas fa-barcode"></i> ${product.barcode}` : 'بدون باركود'}
                            ${product.price ? ` | <span class="text-green-600">${product.price.toFixed(2)} ج.م</span>` : ''}
                        </div>
                    </div>
                    <button onclick="createLink(${currentSourceProduct.id}, ${product.product_id})"
                            class="bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600">
                        <i class="fas fa-link"></i> ربط
                    </button>
                </div>
            `).join('');
        } catch (err) {
            console.error('Error searching:', err);
            container.innerHTML = '<div class="text-center py-4 text-red-500">حدث خطأ في البحث</div>';
        }
    }

    async function createLink(productAId, productBId) {
        try {
            await fetchAPI('/product-links', {
                method: 'POST',
                body: JSON.stringify({
                    product_a_id: productAId,
                    product_b_id: productBId
                })
            });

            showToast('تم ربط المنتج بنجاح', 'success');
            closeLinkModal();
            loadMatrix(currentPage);
        } catch (err) {
            console.error('Error creating link:', err);
            showToast('حدث خطأ في ربط المنتج', 'error');
        }
    }

    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => loadMatrix(1), 300);
    }

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeLinkModal();
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadMatrix);
</script>
{% endblock %}
