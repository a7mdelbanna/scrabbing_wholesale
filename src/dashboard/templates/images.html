{% extends "base.html" %}

{% block title %}تحميل الصور{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">
            <i class="fas fa-images text-orange-500"></i>
            تحميل صور المنتجات
        </h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Download Options Panel -->
        <div class="lg:col-span-1 space-y-4">
            <!-- Filters Card -->
            <div class="bg-white rounded-lg shadow p-5">
                <h3 class="font-semibold text-lg mb-4 flex items-center gap-2">
                    <i class="fas fa-filter text-blue-500"></i>
                    فلترة المنتجات
                </h3>

                <div class="space-y-4">
                    <!-- Source App -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">التطبيق</label>
                        <select id="source-app" class="w-full border rounded-lg px-3 py-2">
                            <option value="">جميع التطبيقات</option>
                            <option value="ben_soliman">بن سليمان</option>
                            <option value="tager_elsaada">تاجر السعادة</option>
                            <option value="el_rabie">الربيع</option>
                            <option value="gomla_shoaib">جملة شعيب</option>
                        </select>
                    </div>

                    <!-- Category -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">التصنيف</label>
                        <select id="category-id" class="w-full border rounded-lg px-3 py-2">
                            <option value="">جميع التصنيفات</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Brand -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">الماركة</label>
                        <select id="brand-id" class="w-full border rounded-lg px-3 py-2">
                            <option value="">جميع الماركات</option>
                            {% for brand in brands %}
                            <option value="{{ brand.id }}">{{ brand.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Max Images -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">الحد الأقصى للصور</label>
                        <input type="number" id="max-images" class="w-full border rounded-lg px-3 py-2" value="100" min="1" max="10000">
                    </div>
                </div>
            </div>

            <!-- Structure Options Card -->
            <div class="bg-white rounded-lg shadow p-5">
                <h3 class="font-semibold text-lg mb-4 flex items-center gap-2">
                    <i class="fas fa-folder-tree text-green-500"></i>
                    هيكل المجلدات
                </h3>

                <div class="space-y-2">
                    <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="folder-structure" value="by_store" checked class="text-blue-600">
                        <div>
                            <span class="font-medium">حسب المتجر</span>
                            <span class="text-xs text-gray-500 block">ben_soliman/image.jpg</span>
                        </div>
                    </label>
                    <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="folder-structure" value="by_category" class="text-blue-600">
                        <div>
                            <span class="font-medium">حسب التصنيف</span>
                            <span class="text-xs text-gray-500 block">ben_soliman/مشروبات/image.jpg</span>
                        </div>
                    </label>
                    <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="folder-structure" value="by_brand" class="text-blue-600">
                        <div>
                            <span class="font-medium">حسب الماركة</span>
                            <span class="text-xs text-gray-500 block">ben_soliman/بيبسي/image.jpg</span>
                        </div>
                    </label>
                    <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="folder-structure" value="flat" class="text-blue-600">
                        <div>
                            <span class="font-medium">مجلد واحد</span>
                            <span class="text-xs text-gray-500 block">all/image.jpg</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Naming Options Card -->
            <div class="bg-white rounded-lg shadow p-5">
                <h3 class="font-semibold text-lg mb-4 flex items-center gap-2">
                    <i class="fas fa-tag text-purple-500"></i>
                    تسمية الملفات
                </h3>

                <div class="space-y-2">
                    <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="naming-convention" value="auto" checked class="text-blue-600">
                        <div>
                            <span class="font-medium">تلقائي (موصى)</span>
                            <span class="text-xs text-gray-500 block">barcode > sku > external_id</span>
                        </div>
                    </label>
                    <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="naming-convention" value="barcode" class="text-blue-600">
                        <div>
                            <span class="font-medium">الباركود</span>
                            <span class="text-xs text-gray-500 block ltr">6223007943765.jpg</span>
                        </div>
                    </label>
                    <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="naming-convention" value="sku" class="text-blue-600">
                        <div>
                            <span class="font-medium">SKU</span>
                            <span class="text-xs text-gray-500 block ltr">SKU123.jpg</span>
                        </div>
                    </label>
                    <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="naming-convention" value="barcode_source" class="text-blue-600">
                        <div>
                            <span class="font-medium">باركود + متجر</span>
                            <span class="text-xs text-gray-500 block ltr">6223007943765_ben_soliman.jpg</span>
                        </div>
                    </label>
                    <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                        <input type="radio" name="naming-convention" value="external_id" class="text-blue-600">
                        <div>
                            <span class="font-medium">المعرف الخارجي</span>
                            <span class="text-xs text-gray-500 block ltr">ben_soliman_3012204.jpg</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Download Button -->
            <button id="start-download-btn" onclick="startImageDownload()" class="w-full bg-orange-500 text-white py-3 rounded-lg hover:bg-orange-600 flex items-center justify-center gap-2 font-semibold text-lg shadow-lg">
                <i class="fas fa-cloud-download-alt"></i>
                بدء التحميل
            </button>

            <!-- Preview Button -->
            <button onclick="previewImages()" class="w-full bg-gray-100 text-gray-700 py-2 rounded-lg hover:bg-gray-200 flex items-center justify-center gap-2">
                <i class="fas fa-eye"></i>
                معاينة الصور
            </button>
        </div>

        <!-- Right Panel: Status & Jobs -->
        <div class="lg:col-span-2 space-y-4">
            <!-- Active Job Status -->
            <div id="active-job-card" class="bg-white rounded-lg shadow p-5 hidden">
                <h3 class="font-semibold text-lg mb-4 flex items-center gap-2">
                    <i class="fas fa-spinner fa-spin text-blue-500"></i>
                    <span id="job-title">جاري التحميل...</span>
                </h3>

                <div class="space-y-4">
                    <!-- Progress Bar -->
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>التقدم</span>
                            <span id="progress-text">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="progress-bar" class="bg-blue-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div id="total-images" class="text-2xl font-bold text-gray-700">-</div>
                            <div class="text-xs text-gray-500">إجمالي الصور</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3">
                            <div id="downloaded-images" class="text-2xl font-bold text-green-600">0</div>
                            <div class="text-xs text-gray-500">تم التحميل</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-3">
                            <div id="failed-images" class="text-2xl font-bold text-red-600">0</div>
                            <div class="text-xs text-gray-500">فشل</div>
                        </div>
                    </div>

                    <!-- Status Message -->
                    <div id="job-status-msg" class="text-sm text-gray-600"></div>

                    <!-- Download Button (shown when complete) -->
                    <a id="download-zip-btn" href="#" class="hidden w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 flex items-center justify-center gap-2 font-semibold">
                        <i class="fas fa-file-archive"></i>
                        <span>تحميل ملف ZIP</span>
                        <span id="zip-size" class="text-sm opacity-75"></span>
                    </a>
                </div>
            </div>

            <!-- Previous Jobs -->
            <div class="bg-white rounded-lg shadow p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg flex items-center gap-2">
                        <i class="fas fa-history text-gray-500"></i>
                        عمليات التحميل السابقة
                    </h3>
                    <button onclick="loadImageJobs()" class="text-blue-500 hover:underline text-sm">
                        <i class="fas fa-sync-alt"></i> تحديث
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">#</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">الحالة</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">الصور</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">الحجم</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">التاريخ</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-500">تحميل</th>
                            </tr>
                        </thead>
                        <tbody id="jobs-table-body" class="divide-y divide-gray-200">
                            <tr><td colspan="6" class="text-center py-8 text-gray-500">جاري التحميل...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Images Preview -->
            <div id="preview-panel" class="bg-white rounded-lg shadow p-5 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold text-lg flex items-center gap-2">
                        <i class="fas fa-images text-orange-500"></i>
                        <span>معاينة الصور</span>
                        <span id="preview-count" class="text-sm font-normal text-gray-500"></span>
                    </h3>
                    <button onclick="document.getElementById('preview-panel').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="preview-grid" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 max-h-96 overflow-y-auto">
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentJobId = null;
    let pollInterval = null;

    async function startImageDownload() {
        const sourceApp = document.getElementById('source-app').value;
        const categoryId = document.getElementById('category-id').value;
        const brandId = document.getElementById('brand-id').value;
        const maxImages = parseInt(document.getElementById('max-images').value) || 100;
        const folderStructure = document.querySelector('input[name="folder-structure"]:checked').value;
        const namingConvention = document.querySelector('input[name="naming-convention"]:checked').value;

        const requestBody = {
            folder_structure: folderStructure,
            naming_convention: namingConvention,
            max_images: maxImages
        };

        if (sourceApp) requestBody.source_app = sourceApp;
        if (categoryId) requestBody.category_id = parseInt(categoryId);
        if (brandId) requestBody.brand_id = parseInt(brandId);

        try {
            // Disable button
            const btn = document.getElementById('start-download-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري البدء...';

            const data = await fetchAPI('/images/download', {
                method: 'POST',
                body: JSON.stringify(requestBody)
            });

            currentJobId = data.id;
            showToast('تم بدء عملية التحميل', 'success');

            // Show active job card
            showActiveJobCard(data);

            // Start polling
            startPolling(data.id);

        } catch (err) {
            console.error('Error starting download:', err);
        } finally {
            const btn = document.getElementById('start-download-btn');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> بدء التحميل';
        }
    }

    function showActiveJobCard(job) {
        const card = document.getElementById('active-job-card');
        card.classList.remove('hidden');

        updateJobDisplay(job);
    }

    function updateJobDisplay(job) {
        // Update title
        const titleEl = document.getElementById('job-title');
        if (job.status === 'completed') {
            titleEl.innerHTML = '<i class="fas fa-check-circle text-green-500"></i> اكتمل التحميل';
        } else if (job.status === 'failed') {
            titleEl.innerHTML = '<i class="fas fa-times-circle text-red-500"></i> فشل التحميل';
        } else {
            titleEl.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500"></i> جاري التحميل...';
        }

        // Update progress
        const progress = job.progress_percent || 0;
        document.getElementById('progress-bar').style.width = progress + '%';
        document.getElementById('progress-text').textContent = progress + '%';

        // Update stats
        document.getElementById('total-images').textContent = job.total_images || '-';
        document.getElementById('downloaded-images').textContent = job.downloaded_images || 0;
        document.getElementById('failed-images').textContent = job.failed_images || 0;

        // Update status message
        const statusMsg = document.getElementById('job-status-msg');
        if (job.error_message) {
            statusMsg.innerHTML = `<span class="text-red-500"><i class="fas fa-exclamation-circle"></i> ${job.error_message}</span>`;
        } else if (job.status === 'completed') {
            statusMsg.innerHTML = '<span class="text-green-500"><i class="fas fa-check"></i> تم تحميل الصور بنجاح</span>';
        } else if (job.status === 'processing') {
            statusMsg.innerHTML = '<span class="text-blue-500"><i class="fas fa-download"></i> جاري تحميل الصور...</span>';
        }

        // Show/hide download button
        const downloadBtn = document.getElementById('download-zip-btn');
        if (job.status === 'completed' && job.download_url) {
            downloadBtn.href = API_BASE + job.download_url;
            downloadBtn.classList.remove('hidden');
            if (job.file_size_bytes) {
                document.getElementById('zip-size').textContent = '(' + formatBytes(job.file_size_bytes) + ')';
            }
        } else {
            downloadBtn.classList.add('hidden');
        }
    }

    function startPolling(jobId) {
        // Clear existing interval
        if (pollInterval) clearInterval(pollInterval);

        pollInterval = setInterval(async () => {
            try {
                const job = await fetchAPI(`/images/download/${jobId}`);
                updateJobDisplay(job);

                // Stop polling if completed or failed
                if (job.status === 'completed' || job.status === 'failed') {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    loadImageJobs(); // Refresh jobs list
                }
            } catch (err) {
                console.error('Polling error:', err);
                clearInterval(pollInterval);
            }
        }, 2000);
    }

    async function previewImages() {
        const sourceApp = document.getElementById('source-app').value;
        const categoryId = document.getElementById('category-id').value;
        const brandId = document.getElementById('brand-id').value;
        const maxImages = Math.min(parseInt(document.getElementById('max-images').value) || 100, 50);

        let url = `/images/list?max_images=${maxImages}`;
        if (sourceApp) url += `&source_app=${sourceApp}`;
        if (categoryId) url += `&category_id=${categoryId}`;
        if (brandId) url += `&brand_id=${brandId}`;

        try {
            const images = await fetchAPI(url);

            const panel = document.getElementById('preview-panel');
            const grid = document.getElementById('preview-grid');
            const countEl = document.getElementById('preview-count');

            countEl.textContent = `(${images.length} صورة)`;

            grid.innerHTML = images.map(img => `
                <div class="relative group">
                    <img src="${img.image_url}"
                         class="w-full h-20 object-cover rounded border hover:border-blue-500 cursor-pointer"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23f3f4f6%22 width=%22100%22 height=%22100%22/><text x=%2250%%22 y=%2250%%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No Image</text></svg>'"
                         title="${img.filename}">
                    <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity rounded flex items-center justify-center">
                        <span class="text-white text-xs truncate px-1">${img.filename}</span>
                    </div>
                </div>
            `).join('');

            panel.classList.remove('hidden');
        } catch (err) {
            console.error('Preview error:', err);
        }
    }

    async function loadImageJobs() {
        try {
            // Get export jobs of type images_zip
            const data = await fetchAPI('/export/jobs?per_page=10');
            const tbody = document.getElementById('jobs-table-body');

            // Filter only image jobs
            const imageJobs = data.data.filter(job => job.job_type === 'images_zip');

            if (imageJobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">لا توجد عمليات تحميل صور</td></tr>';
                return;
            }

            const statusColors = {
                'completed': 'bg-green-100 text-green-800',
                'processing': 'bg-yellow-100 text-yellow-800',
                'pending': 'bg-gray-100 text-gray-800',
                'failed': 'bg-red-100 text-red-800'
            };

            const statusLabels = {
                'completed': 'مكتمل',
                'processing': 'قيد التنفيذ',
                'pending': 'قيد الانتظار',
                'failed': 'فشل'
            };

            tbody.innerHTML = imageJobs.map(job => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm">${job.id}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded-full ${statusColors[job.status] || 'bg-gray-100'}">
                            ${statusLabels[job.status] || job.status}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">${job.records_count || '-'}</td>
                    <td class="px-4 py-3 text-sm">${job.file_size_bytes ? formatBytes(job.file_size_bytes) : '-'}</td>
                    <td class="px-4 py-3 text-sm">${new Date(job.created_at).toLocaleString('ar-EG')}</td>
                    <td class="px-4 py-3">
                        ${job.status === 'completed' ? `
                            <a href="${API_BASE}/images/download/${job.id}/file" class="text-blue-500 hover:text-blue-700">
                                <i class="fas fa-download"></i>
                            </a>
                        ` : job.status === 'processing' || job.status === 'pending' ? `
                            <button onclick="startPolling(${job.id}); showActiveJobCard({id: ${job.id}, status: '${job.status}'})" class="text-orange-500 hover:text-orange-700">
                                <i class="fas fa-eye"></i>
                            </button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            console.error('Error loading jobs:', err);
        }
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Load jobs on page load
    document.addEventListener('DOMContentLoaded', loadImageJobs);
</script>
{% endblock %}
